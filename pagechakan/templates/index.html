<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>文件检索与谱图分析系统 / File Search and Spectra Analysis System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
    <style>
        #spectraPlot {
            width: 100%;
            height: 70vh;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 20px 0;
        }
        .fixed-bottom {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .list-group-item.active {
            background-color: #e9f5ff;
            border-color: #86b7fe;
            color: #0a58ca;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">文件检索与谱图分析系统 / File Search and Spectra Analysis System</h1>
        
        <div class="input-group mb-3">
            <input type="text" id="searchInput" class="form-control" 
                   placeholder="输入文件名关键词... / Enter filename keyword..." aria-label="搜索 / Search">
            <button class="btn btn-primary" onclick="performSearch()">搜索 / Search</button>
        </div>

        <div id="results">
            <div id="pdfResults" class="mb-4"></div>
            <div id="csvResults"></div>
        </div>
        
        <div id="spectraPlot"></div>
    </div>

    <!-- CSV预览模态框 / CSV Preview Modal -->
    <div class="modal fade" id="csvPreviewModal">
        <!-- 原有模态框内容保持不变 / Original modal content remains unchanged -->
    </div>

    <!-- 底部控制栏 / Bottom Control Bar -->
    <div class="fixed-bottom bg-light py-3 border-top">
        <div class="container">
            <button class="btn btn-success" onclick="plotSelectedSpectra()">
                绘制选中谱图 / Plot Selected Spectra（已选择 <span id="selectedCount">0</span> 个文件 / files）
            </button>
        </div>
    </div>

    <script>
        let selectedFiles = new Set();

        function performSearch() {
            const query = $('#searchInput').val().trim();
            if (!query) {
                alert('请输入搜索关键词 / Please enter search keyword');
                return;
            }
            
            $.get(`/search?q=${encodeURIComponent(query)}`)
                .done(displayResults)
                .fail(xhr => alert('搜索失败 / Search failed: ' + xhr.responseJSON?.error || '服务器错误 / Server error'));
        }

        function displayResults(data) {
            // 显示PDF结果 / Display PDF results
            let pdfHtml = '<h4>PDF文件 / PDF Files</h4>';
            if (data.pdf && data.pdf.length) {
                pdfHtml += '<div class="list-group">';
                data.pdf.forEach(file => {
                    pdfHtml += `
                        <a href="/files/${encodeURIComponent(file)}" 
                           class="list-group-item list-group-item-action" 
                           target="_blank">
                            ${file}
                        </a>`;
                });
                pdfHtml += '</div>';
            } else {
                pdfHtml += '<p>未找到匹配的PDF文件 / No matching PDF files found</p>';
            }
            $('#pdfResults').html(pdfHtml);

            // 更新CSV结果显示 / Update CSV results display
            let csvHtml = '<h4>CSV文件 / CSV Files</h4>';
            if (data.csv?.length) {
                csvHtml += '<div class="list-group">';
                data.csv.forEach(file => {
                    const isActive = selectedFiles.has(file);
                    csvHtml += `
                        <a href="javascript:void(0)" 
                           class="list-group-item list-group-item-action csv-preview d-flex justify-content-between align-items-center
                           ${isActive ? 'active' : ''}"
                           data-filename="${file}"
                           onclick="toggleFileSelection('${file}')">
                            ${file}
                            <span class="badge bg-primary rounded-pill">${isActive ? '✓' : ''}</span>
                        </a>`;
                });
                csvHtml += '</div>';
            } else {
                csvHtml += '<p>未找到匹配的CSV文件 / No matching CSV files found</p>';
            }
            $('#csvResults').html(csvHtml);
        }

        function toggleFileSelection(filename) {
            if (selectedFiles.has(filename)) {
                selectedFiles.delete(filename);
            } else {
                selectedFiles.add(filename);
            }
            $('#selectedCount').text(selectedFiles.size);
            performSearch();  // 刷新显示选中状态 / Refresh display selection status
        }

        function plotSelectedSpectra() {
            if (selectedFiles.size === 0) {
                alert('请先选择至少一个CSV文件 / Please select at least one CSV file first');
                return;
            }

            $.ajax({
                url: '/plot_spectra',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({files: Array.from(selectedFiles)}),
                success: function(response) {
                    if (response.error) {
                        alert('错误 / Error: ' + response.error);
                        return;
                    }
                    drawSpectraPlot(response);
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON?.error || '请求失败 / Request failed';
                    alert('错误 / Error: ' + errorMsg);
                }
            });
        }

        function drawSpectraPlot(data) {
            const traces = Object.entries(data.spectra).map(([filename, y]) => ({
                x: data.x,
                y: y,
                name: filename,
                mode: 'lines',
                line: {width: 1}
            }));

            Plotly.newPlot('spectraPlot', traces, {
                title: '归一化谱图叠加 / Normalized Spectra Overlay',
                xaxis: {title: 'X轴 / X-axis'},
                yaxis: {title: '归一化强度 / Normalized Intensity', range: [0, 1.1]},
                showlegend: true,
                height: 600,
                margin: {l: 60, r: 30, t: 60, b: 60}
            });
        }
    </script>
</body>
</html>
